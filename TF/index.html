<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Track Demo</title>
	 <style>
		body {
			font-size: 12px;
			font-family: Arial;
			overflow: scroll;
		}
	    .scrollable-menu {
			height: auto;
			max-height: 200px;
			overflow-x: hidden;
		}
		.li-event-selector {
			cursor: pointer;
		}
		#myProgress {
		    width: 50%;
			top: 25%;
			left: 25%;
			position: absolute;
			background-color: #ddd;
			visibility: hidden;
			z-index: 9999999999;
		}

		#myBar {
			width: 0%;
			height: 30px;
			background-color: black;
			text-align: center;
			line-height: 30px;
			color: white;
		}
		.btn-group{
			position: fixed !important;
			top: 10px;
			right: 10px;
			z-index: 99999999999999;
		}
	</style>
	<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js" charset="utf-8"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
	<link rel="stylesheet" href="lib//MarkerCluster.css" />
	<link rel="stylesheet" href="lib/MarkerCluster.Default.css" />
	<script src="lib/leaflet.markercluster-src.js"></script>
</head>
<body>
<div class="btn-group">
	<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Select Event<span class="caret"></span></button>
	<ul class="dropdown-menu scrollable-menu pull-right" id="eventDropdown"role="menu">
	</ul>
</div>
<div id="info-anno" style="padding-left: 5px; width:240px; position:absolute; top:270px; left:10px; z-index: 90000; background-color: rgba(255, 255, 255, 0.75);"></div>
<div id="legend" style="padding: 5px 10px; position:absolute; top:10px; left:10px; z-index: 90000; background-color: rgba(255, 255, 255, 0.9); border-radius: 4px; font-size: 11px; max-width: 200px;">
	<strong>Legend</strong><br>
	Bar height = relative time (taller = slower)<br>
	Hover over bars for details
</div>
<div id="mapid" style="width: 100%; height: 400px;"></div>
<!-- Histogram Labels (positioned outside new-projects so they don't get cleared) -->
<div id="histogram-labels" style="position: absolute; top: 450px; left: 2.5%; display: none;">
	<div style="position: absolute; top: -20px; left: 0; font-weight: bold; font-size: 14px; color: #333;">ðŸ“Š Performance by Rank (fastest â†’ slowest)</div>
	<div style="position: absolute; top: 205px; left: 0; font-weight: bold; font-size: 14px; color: #333;">ðŸ“… Performance by Date (earliest â†’ latest)</div>
	<div style="position: absolute; top: 480px; left: 0; font-weight: bold; font-size: 14px; color: #333;">ðŸŽ‚ Performance by Athlete Age (youngest â†’ oldest)</div>
</div>
<div id="new-projects" style="display: -webkit-inline-box; position: absolute; top:450px; left: 2.5%;"></div>
<div id="myProgress">
	<div id="myBar">0%</div>
</div>
<script>
//Global vars...
// Updated event codes to match PHP API format (must match alltime-athletics.com URLs)
var configurations = [
	["Men's Marathon", "mmara", 600000],
	["Men's Half Marathon", "mhmara", 280000],
	["Men's 10,000", "m10000", 140000],
	["Men's 5,000", "m_5000", 82000],
	["Men's 3,000", "m_3000", 47000],
	["Women's 5,000", "w_5000", 150000],
	["Women's 3,000", "w_3000", 199000]
];
var cutOffValue = 500000;
var lines = 0;
var deviceWidth = ((window.innerWidth > 0) ? window.innerWidth : screen.width) * 0.95;
var widthBar = 0.3;
var arrayArray = []
var highestDate = 0;
var lowestDate = 999999999999999999999999;
var highestTtl = 0;
var lowestTtl = 999999999999999999999999;
var highestAge = 0;
var lowestAge = 999999999999999999999999;


var mymap = L.map('mapid').setView([0, 0], 2);

L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
	subdomains: 'abcd',
	maxZoom: 19
}).addTo(mymap);

for (f = 0; f < configurations.length; f++){
	$("#eventDropdown").append('<li><a class="li-event-selector" onClick="engageEvent(\''+ configurations[f][1] +'\','+ configurations[f][2] +')">' + configurations[f][0] + '</a></li>')
}

function loadingBar(onOff){
	if (onOff == "ON"){
		$("#myProgress").css("visibility", "visible")
		$("#myBar").css("width", "50%"); 
		$("#myBar").html("loading...")
	}else{
		$("#myProgress").css("visibility", "hidden")
	}
}

function engageEvent(eventIn, cutOff){
	cutOffValue = cutOff;
	loadingBar("ON")
	$("#new-projects").html("")
	markers.clearLayers(); // Clear existing markers
	
	// NEW: Use our PHP API instead of Yahoo YQL
	var apiUrl = "api/scraper.php?event=" + eventIn;
	$.getJSON(apiUrl, function(response) { 
		if (response.error) {
			console.error("API Error:", response.error);
			loadingBar("OFF");
			return;
		}
		
		// Convert API response to the format expected by parseBigString
		var bigString = convertApiResponseToLegacyFormat(response.records);
		parseBigString(bigString);
		makeMoreStuff();
	}).fail(function(jqXHR, textStatus, errorThrown) {
		console.error("Failed to fetch data:", textStatus, errorThrown);
		loadingBar("OFF");
	});
}

// Convert new API JSON format to legacy string format for minimal code changes
function convertApiResponseToLegacyFormat(records) {
	var lines = [];
	lines.push("HEADER LINE"); // Placeholder for header (skipped in parseBigString)
	
	for (var i = 0; i < records.length; i++) {
		var r = records[i];
		// Format: rank   time   athlete   country   dob   position   location   date
		var line = [
			r.rank || '',
			r.time || '',
			r.athlete || '',
			r.country || '',
			r.dob || '',
			r.position || '',
			r.location || '',
			r.date || ''
		].join('   ');
		lines.push(line);
	}
	
	return lines.join('\n');
}

var markers = L.markerClusterGroup();
var only50 = 0
var locationCache = {"myHouse":{"lat":40.7127753,"lng":-74.0059728},"Paris":{"lat":48.856614,"lng":2.3522219},"Stockholm":{"lat":59.32932349999999,"lng":18.0685808},"Beijing":{"lat":39.90419989999999,"lng":116.4073963},"Jinan":{"lat":36.6512,"lng":117.120095},"Seoul":{"lat":37.566535,"lng":126.9779692},"Bruxelles":{"lat":50.8503463,"lng":4.3517211},"Monaco":{"lat":43.73841760000001,"lng":7.424615799999999},"Kiev":{"lat":50.4501,"lng":30.5234},"Stuttgart":{"lat":48.7758459,"lng":9.1829321},"Birmingham":{"lat":52.48624299999999,"lng":-1.890401},"Roma":{"lat":41.9027835,"lng":12.4963655},"London":{"lat":51.5073509,"lng":-0.1277583},"Leningrad":{"lat":59.9342802,"lng":30.3350986},"Ad-Dawhah":{"lat":25.2854473,"lng":51.53103979999999},"Nice":{"lat":43.7101728,"lng":7.261953200000001},"ZÃ¼rich":{"lat":47.3768866,"lng":8.541694},"Saint-Denis":{"lat":48.936181,"lng":2.357443},"Oslo":{"lat":59.9138688,"lng":10.7522454},"Rabat":{"lat":33.9715904,"lng":-6.8498129},"College Park":{"lat":38.9896967,"lng":-76.93776}, "New York City":{"lat":40.7127753,"lng":-74.0059728},"Los Angeles":{"lat":34.0522342,"lng":-118.2436849},"Berlin":{"lat":52.52000659999999,"lng":13.404954},"Shanghai":{"lat":31.2303904,"lng":121.4737021},"Durban":{"lat":-29.85868039999999,"lng":31.0218404},"Rieti":{"lat":42.404509,"lng":12.8567281},"Podolsk":{"lat":55.4312453,"lng":37.5457647},"Hengelo":{"lat":52.2574121,"lng":6.7927725},"Tula":{"lat":54.204836,"lng":37.6184915},"Ryazan":{"lat":54.6095418,"lng":39.7125857},"Lausanne":{"lat":46.5196535,"lng":6.6322734},"Bucuresti":{"lat":44.4267674,"lng":26.1025384},"Victoria":{"lat":28.8052674,"lng":-97.0035982},"Praha":{"lat":50.0755381,"lng":14.4378005},"AthÃ­nai":{"lat":37.9838096,"lng":23.7275388},"Moskva":{"lat":55.755826,"lng":37.6172999},"Sochi":{"lat":43.60280789999999,"lng":39.7341543},"Helsinki":{"lat":60.16985569999999,"lng":24.9383791},"ThessalonÃ­ki":{"lat":40.6400629,"lng":22.9444191},"Eugene":{"lat":44.0520691,"lng":-123.0867536},"KÃ¶ln":{"lat":50.937531,"lng":6.9602786},"Christchurch":{"lat":-43.5320544,"lng":172.6362254},"Tallinn":{"lat":59.43696079999999,"lng":24.7535747},"Edinburgh":{"lat":55.953252,"lng":-3.188267},"Tokyo":{"lat":35.6894875,"lng":139.6917064},"Donetsk":{"lat":48.015883,"lng":37.80285},"Koblenz":{"lat":50.3569429,"lng":7.5889959},"Gateshead":{"lat":54.95268,"lng":-1.603411},"MontrÃ©al":{"lat":45.5016889,"lng":-73.567256},"Belfast":{"lat":54.59728500000001,"lng":-5.93012},"Larvik":{"lat":59.0538363,"lng":10.0295463},"Firenze":{"lat":43.7695604,"lng":11.2558136},"Huelva":{"lat":37.261421,"lng":-6.9447224},"Zagreb":{"lat":45.8150108,"lng":15.9819189},"Cottbus":{"lat":51.75631079999999,"lng":14.3328679}, "Auckland":{"lat":-36.8484597,"lng":174.7633315},"Sheffield":{"lat":53.38112899999999,"lng":-1.470085},"Stellenbosch":{"lat":-33.9321045,"lng":18.860152},"Madrid":{"lat":40.4167754,"lng":-3.7037902},"Ã…rhus":{"lat":56.162939,"lng":10.203921},"Ostrava":{"lat":49.8209226,"lng":18.2625243},"Indianapolis":{"lat":39.768403,"lng":-86.158068},"Kekrade":{"lat":50.8659457,"lng":6.0705486},"Potsdam":{"lat":52.3905689,"lng":13.0644729},"Sevilla":{"lat":37.3890924,"lng":-5.9844589},"Milano":{"lat":35.9197885,"lng":-88.7589488},"Vilnius":{"lat":54.6871555,"lng":25.2796514},"Kharkov":{"lat":49.9935,"lng":36.230383},"Bydgoszcz":{"lat":53.12348040000001,"lng":18.0084378},"Cork":{"lat":51.8968917,"lng":-8.4863157},"Reims":{"lat":49.258329,"lng":4.031696},"Edwardsville":{"lat":38.8114364,"lng":-89.95315699999999},"Melbourne":{"lat":-37.8136276,"lng":144.9630576},"Bergen":{"lat":60.39126279999999,"lng":5.3220544},"Ã˜vre-Ã˜rdal":{"lat":63.8863371,"lng":11.4315677},"Annecy":{"lat":45.899247,"lng":6.129384},"Dakar":{"lat":14.716677,"lng":-17.4676861},"Montreuil-sous-Bois":{"lat":48.863812,"lng":2.448451},"Sankt Peterburg":{"lat":59.9342802,"lng":30.3350986},"Kazan":{"lat":55.8304307,"lng":49.06608060000001},"Villeneuve d'Ascq":{"lat":50.6232523,"lng":3.1442651},"Istanbul":{"lat":41.0082376,"lng":28.9783589},"Pitesti":{"lat":44.8564798,"lng":24.8691824},"Riga":{"lat":56.9496487,"lng":24.1051865},"New Orleans":{"lat":29.95106579999999,"lng":-90.0715323},"Kaunas":{"lat":54.8985207,"lng":23.9035965},"Vila Real de Santo AntÃ³nio  24.05.2008":{"lat":41.30169859999999,"lng":-7.7428302},"Steinkjer":{"lat":64.01501929999999,"lng":11.4952627},"Bodo":{"lat":67.2803556,"lng":14.404916},"CastellÃ³n":{"lat":40.1451772,"lng":-0.1494988},"Port Elisabeth":{"lat":-33.7139247,"lng":25.5207358},"Barcelona":{"lat":41.3850639,"lng":2.1734035},"Split":{"lat":43.5081323,"lng":16.4401935},"Irkutsk":{"lat":52.28697409999999,"lng":104.3050183},"San JosÃ©":{"lat":37.3382082,"lng":-121.8863286},"Portland":{"lat":45.5230622,"lng":-122.6764815},"Fukuroi":{"lat":34.7501735,"lng":137.9246792},"Berkeley":{"lat":37.8718992,"lng":-122.2585399},"DÃ¼sseldorf":{"lat":51.2277411,"lng":6.7734556},"Lappeenranta":{"lat":61.05499289999999,"lng":28.1896627},"Sydney":{"lat":-33.8688197,"lng":151.2092955},"MÃ¼nchen":{"lat":48.1351253,"lng":11.5819805},"RÃ©thymno":{"lat":35.3643615,"lng":24.4821552},"La CoruÃ±a":{"lat":43.3623436,"lng":-8.4115401},"Basel":{"lat":47.5595986,"lng":7.5885761},"Sofia":{"lat":42.6977082,"lng":23.3218675},"Tampere":{"lat":61.4977524,"lng":23.7609535},"Belville":{"lat":29.9502253,"lng":-96.2571858},"Carson":{"lat":42.0674325,"lng":-88.34437059999999},"Lisboa":{"lat":38.7222524,"lng":-9.1393366},"Zhukovskiy":{"lat":55.5974912,"lng":38.1132562},"Frankfurt":{"lat":50.1109221,"lng":8.6821267},"Duisburg":{"lat":51.4344079,"lng":6.762329299999999},"Dortmund":{"lat":51.5135872,"lng":7.465298100000001},"Bergisch Gladbach":{"lat":50.9923091,"lng":7.1286213},"Budapest":{"lat":47.497912,"lng":19.040235},"Rovereto":{"lat":45.89096,"lng":11.0401399},"Gent":{"lat":51.0543422,"lng":3.7174243},"Lahti":{"lat":60.98267490000001,"lng":25.6612096},"Haldensleben":{"lat":52.284424,"lng":11.4181493},"Maebashi":{"lat":36.3894816,"lng":139.0634281},"Valencia":{"lat":28.5217717,"lng":-81.4634578},"Wien":{"lat":48.2081743,"lng":16.3738189},"Hangzhou":{"lat":30.274084,"lng":120.15507},"Sumy":{"lat":50.9077,"lng":34.7981},"Erfurt":{"lat":50.98476789999999,"lng":11.02988},"Boston":{"lat":42.3600825,"lng":-71.0588801},"LiÃ©vin":{"lat":50.417921,"lng":2.775222},"Glasgow":{"lat":55.864237,"lng":-4.251806},"Beograd":{"lat":44.786568,"lng":20.4489216},"Fayetteville":{"lat":35.0526641,"lng":-78.87835849999999},"Cosford":{"lat":52.6463589,"lng":-2.297577},"Karlsruhe":{"lat":49.0068901,"lng":8.4036527},"East Rutherford":{"lat":40.833989,"lng":-74.0970865},"Volgograd":{"lat":48.708048,"lng":44.5133035},"Genova":{"lat":35.609611,"lng":-82.568876},"Roxbury":{"lat":42.3151978,"lng":-71.0913748},"College Station":{"lat":30.627977,"lng":-96.3344068},"Sabadell":{"lat":41.5462745,"lng":2.1086131},"Hechtel":{"lat":51.12509,"lng":5.3670663},"Torino":{"lat":45.070312,"lng":7.686856499999999},"Narbonne":{"lat":33.8036845,"lng":-118.3065119},"Naimette-XhovÃ©mont":{"lat":50.65172279999999,"lng":5.557602},"Kerkrade":{"lat":50.8659457,"lng":6.0705486},"Ingelheim":{"lat":49.9764195,"lng":8.0560682},"Bellinzona":{"lat":46.1946216,"lng":9.0244124},"San SebastiÃ¡n":{"lat":43.318334,"lng":-1.9812313},"Caorle":{"lat":45.6030238,"lng":12.8859589},"Tangiers":{"lat":35.7594651,"lng":-5.833954299999999},"Palo Alto":{"lat":37.4418834,"lng":-122.1430195},"MalmÃ¶":{"lat":55.604981,"lng":13.003822},"Ingolstadt":{"lat":48.7665351,"lng":11.4257541},"Zaragoza":{"lat":41.6488226,"lng":-0.8890853},"Helsingborg":{"lat":56.0464674,"lng":12.6945121},"Bratislava":{"lat":48.1485965,"lng":17.1077478},"Formia":{"lat":41.2559961,"lng":13.6068672},"Oordegem":{"lat":50.9565245,"lng":3.9028634},"Barletta":{"lat":41.3196635,"lng":16.2838207},"Baie Mahault":{"lat":16.2444738,"lng":-61.571718},"Dar-el-Beida":{"lat":36.70601449999999,"lng":3.2281983},"Strasbourg":{"lat":48.5734053,"lng":7.752111299999999},"Sotteville-lÃ¨s-Rouen":{"lat":49.41725,"lng":1.095407},"Arnsberg":{"lat":51.4073375,"lng":8.052771},"Lignano Sabbiadoro":{"lat":45.6685554,"lng":13.1040857},"Grosseto":{"lat":42.7635254,"lng":11.1123634},"Wattenscheid":{"lat":51.4718088,"lng":7.145096},"Kingston":{"lat":41.9270367,"lng":-73.9973608},"KÃ¸benhavn":{"lat":55.6760968,"lng":12.5683372},"Metz":{"lat":49.1193089,"lng":6.175715599999999},"FlorÃ¸":{"lat":61.59948859999999,"lng":5.0314409},"Rehlingen":{"lat":53.104656,"lng":10.2185687},"Parma":{"lat":44.801485,"lng":10.3279036},"Herrera":{"lat":35.1922629,"lng":-107.1147617},"Bochum-Wattenscheid":{"lat":51.4718088,"lng":7.145096},"Luzern":{"lat":47.0795671,"lng":8.1662445},"GÃ¶teborg":{"lat":57.70887,"lng":11.97456},"Brisbane":{"lat":-27.4697707,"lng":153.0251235},"Cagliari":{"lat":39.2238411,"lng":9.1216613},"Rhede":{"lat":51.8374545,"lng":6.6989532},"Trapani":{"lat":38.0176177,"lng":12.537202},"Nairobi":{"lat":-1.2920659,"lng":36.8219462},"SÃ£o Paulo":{"lat":-23.5505199,"lng":-46.63330939999999},"Jerez de la Frontera":{"lat":36.6850064,"lng":-6.126074399999999},"BelÃ©m":{"lat":-1.4557794,"lng":-48.4901968},"Uniondale":{"lat":40.7003793,"lng":-73.5929056},"Portsmouth":{"lat":50.8197675,"lng":-1.0879769},"Gresham":{"lat":45.5059203,"lng":-122.4486119},"Montpellier":{"lat":43.610769,"lng":3.876716},"Oulu":{"lat":65.0120888,"lng":25.4650772},"HaniÃ¡":{"lat":35.5138298,"lng":24.0180367},"Warszawa":{"lat":52.2296756,"lng":21.0122287},"Viareggio":{"lat":43.8657267,"lng":10.2513103},"Westwood":{"lat":30.4562745,"lng":-97.7977106},"Leuven":{"lat":50.8798438,"lng":4.7005176},"Marseille":{"lat":43.296482,"lng":5.36978},"Getxo":{"lat":43.3387367,"lng":-3.0081319},"Tessenderlo":{"lat":51.0642666,"lng":5.0881938},"Durham":{"lat":35.9940329,"lng":-78.898619},"Lindau":{"lat":47.5797815,"lng":9.678933299999999},"El Djezair":{"lat":36.7543872,"lng":3.0462061},"Tirrenia":{"lat":43.6294361,"lng":10.2908632},"Udine":{"lat":46.0710668,"lng":13.2345794},"Turku":{"lat":60.4518126,"lng":22.2666302},"Dublin":{"lat":53.3498053,"lng":-6.2603097},"Jena":{"lat":50.927054,"lng":11.5892372},"Bergamo":{"lat":45.6982642,"lng":9.6772698},"MÃ¼nster":{"lat":51.9606649,"lng":7.6261347},"Loughborough":{"lat":52.772099,"lng":-1.206166},"Bologna":{"lat":44.494887,"lng":11.3426162},"Concord":{"lat":42.4603719,"lng":-71.3489484},"Dessau":{"lat":51.83081660000001,"lng":12.2423302},"Adelaide":{"lat":-34.9284989,"lng":138.6007456},"Bern":{"lat":46.9479739,"lng":7.4474468},"FÃ¨s":{"lat":34.0181246,"lng":-5.0078451},"Sopot":{"lat":54.441581,"lng":18.5600956},"Woluwe":{"lat":50.845727,"lng":4.4371999},"Lugano":{"lat":46.0036778,"lng":8.951051999999999},"Padova":{"lat":45.4064349,"lng":11.8767611},"Leiden":{"lat":52.1601144,"lng":4.4970097},"Massa Marittima":{"lat":43.0532504,"lng":10.8880322},"Lyngby":{"lat":55.763516,"lng":12.4949429},"Nancy":{"lat":48.692054,"lng":6.184417},"SzÃ©kesfehÃ©rvÃ¡r":{"lat":47.18602620000001,"lng":18.4221358},"Newcastle":{"lat":54.978252,"lng":-1.61778},"Celle Ligure":{"lat":44.3426186,"lng":8.545081099999999},"Aix-les-Bains":{"lat":45.692341,"lng":5.908998},"Dijon":{"lat":47.322047,"lng":5.04148},"Kessel-Lo":{"lat":50.88514,"lng":4.73571},"Montgeron":{"lat":48.703859,"lng":2.4604529},"Atlanta":{"lat":33.7489954,"lng":-84.3879824},"Burjassot":{"lat":39.5096699,"lng":-0.4135963},"CÃ¡ceres":{"lat":39.4752765,"lng":-6.3724247},"Dar-es-Salaam":{"lat":-6.792354,"lng":39.2083284},"Saint-Maur":{"lat":48.8029439,"lng":2.485429},"Dubnica nad VÃ¡hom":{"lat":48.9617553,"lng":18.1709914},"Canberra":{"lat":-35.2809368,"lng":149.1300092},"GÃ¶ttingen":{"lat":51.54128040000001,"lng":9.915803499999999},"Shibetsu":{"lat":44.1787338,"lng":142.4004035},"Dreux":{"lat":48.736134,"lng":1.370889},"Cwmbran":{"lat":51.6496546,"lng":-3.0317889},"Linz":{"lat":48.30694,"lng":14.28583},"Levallois-Perret":{"lat":48.89321700000001,"lng":2.287864},"San Marino":{"lat":43.94236,"lng":12.457777},"Kvarnsveden":{"lat":60.5164731,"lng":15.4165905},"Klagenfurt":{"lat":46.6364598,"lng":14.3122246},"Arras":{"lat":50.291002,"lng":2.777535},"Debrecen":{"lat":47.5316049,"lng":21.6273124},"Cuxhaven":{"lat":53.859336,"lng":8.6879057},"Pontevedra":{"lat":42.4298846,"lng":-8.6446202},"Bonn":{"lat":50.73743,"lng":7.0982068},"Xalapa":{"lat":19.5437751,"lng":-96.91018059999999},"VÃ¤sterÃ¥s":{"lat":59.60990049999999,"lng":16.5448092},"Bosvoorde":{"lat":50.7966762,"lng":4.417794},"Patra":{"lat":38.2466395,"lng":21.734574},"Neubrandenburg":{"lat":53.5678292,"lng":13.2779269},"Walnut":{"lat":43.0417746,"lng":-76.13180969999999},"AndÃºjar":{"lat":38.2054888,"lng":-4.028678},"Lapinlahti":{"lat":63.3667365,"lng":27.3921568},"Brasschaat":{"lat":51.29226999999999,"lng":4.49419},"Olbia":{"lat":40.92357639999999,"lng":9.4964429},"Richmond":{"lat":37.5407246,"lng":-77.4360481},"Rio de Janiero":{"lat":-22.9068467,"lng":-43.1728965},"Nantes":{"lat":47.218371,"lng":-1.553621},"Pergine Valsugana":{"lat":46.06174,"lng":11.2369603},"Siderno Marina":{"lat":38.2744568,"lng":16.3103689},"Leverkusen":{"lat":51.04592479999999,"lng":7.0192196},"Mito":{"lat":36.3665027,"lng":140.4709965},"Eurajoki":{"lat":61.2023562,"lng":21.7339845},"Karlskrona":{"lat":56.161224,"lng":15.5869001},"Chiba":{"lat":35.6050574,"lng":140.1233063},"NÃ¼rnberg":{"lat":49.4521018,"lng":11.0766654},"Bremen":{"lat":53.07929619999999,"lng":8.8016936},"Heverlee":{"lat":50.86260720000001,"lng":4.6958889},"Nijmegen":{"lat":51.8125626,"lng":5.8372264},"Corby":{"lat":52.49229829999999,"lng":-0.6842332999999999},"Szczecin":{"lat":53.4285438,"lng":14.5528116},"WipperfÃ¼rth":{"lat":51.1180108,"lng":7.395541700000001},"Napoli":{"lat":42.199784,"lng":-78.89198119999999},"Mulhouse":{"lat":47.750839,"lng":7.335888},"Los Corrales de Buelna":{"lat":43.2597761,"lng":-4.0669902},"Joensuu":{"lat":62.6010155,"lng":29.7635719},"Hannover":{"lat":52.3758916,"lng":9.732010400000002},"Palermo":{"lat":38.1156879,"lng":13.3612671},"Verona":{"lat":45.43838419999999,"lng":10.9916215},"Papendal":{"lat":52.009887,"lng":5.8246005},"Sacramento":{"lat":38.5815719,"lng":-121.4943996},"Kristiansand":{"lat":58.15991189999999,"lng":8.0182064},"Granada":{"lat":37.1773363,"lng":-3.5985571},"Pliezhausen":{"lat":48.5618552,"lng":9.2020103},"VÃ¤xjÃ¶":{"lat":56.8790044,"lng":14.8058523},"LogroÃ±o":{"lat":42.4627195,"lng":-2.4449852},"Nuoro":{"lat":40.32024210000001,"lng":9.3264377},"Kazo":{"lat":42.2355515,"lng":-85.5515933},"Ninove":{"lat":50.8336386,"lng":4.0188286},"MatarÃ³":{"lat":41.5381124,"lng":2.4447406},"Iraklio":{"lat":35.3387352,"lng":25.1442126},"Melun":{"lat":48.542105,"lng":2.6554},"AvilÃ©s":{"lat":43.5579523,"lng":-5.9246653},"Funchal":{"lat":32.6669328,"lng":-16.9240554},"Terra Sarda":{"lat":52.5485708,"lng":13.4202062},"Val-de-Reuil":{"lat":49.272602,"lng":1.217085},"Kortrijk":{"lat":50.8194776,"lng":3.2577263},"MeknÃ¨s":{"lat":33.8730164,"lng":-5.5407299},"FÃ¼rth":{"lat":49.4771169,"lng":10.988667},"Karlstad":{"lat":59.4021806,"lng":13.5114978},"Aachen":{"lat":50.7753455,"lng":6.083886800000001},"San Diego":{"lat":32.715738,"lng":-117.1610838},"Pattaya":{"lat":12.9276082,"lng":100.8770813},"Sindelfingen":{"lat":48.7074558,"lng":9.0044053},"Oviedo":{"lat":28.669997,"lng":-81.20812029999999},"PirÃ¦us":{"lat":37.9429857,"lng":23.6469832},"Bordeaux":{"lat":44.837789,"lng":-0.57918},"Fairfax":{"lat":38.84622359999999,"lng":-77.30637329999999},"Huangzhou":{"lat":30.274084,"lng":120.15507},"Rotterdam":{"lat":51.9244201,"lng":4.4777326},"Mondeville":{"lat":49.176963,"lng":-0.319769},"Albuquerque":{"lat":35.0853336,"lng":-106.6055534},"Daly City":{"lat":37.6879241,"lng":-122.4702079},"Nampa":{"lat":43.5407172,"lng":-116.5634625},"Inglewood":{"lat":33.9616801,"lng":-118.3531311},"Senftenberg":{"lat":51.51897959999999,"lng":13.996908},"Leyden":{"lat":41.9296236,"lng":-87.86479609999999},"Yekaterinburg":{"lat":56.83892609999999,"lng":60.6057025},"Espinho":{"lat":41.0071914,"lng":-8.641033199999999},"Louisville":{"lat":38.2526647,"lng":-85.7584557},"Long Beach":{"lat":33.7700504,"lng":-118.1937395},"Winston-Salem":{"lat":36.09985959999999,"lng":-80.244216},"Madison":{"lat":43.0730517,"lng":-89.4012302},"Grenoble":{"lat":45.188529,"lng":5.724524},"Ottawa":{"lat":45.4215296,"lng":-75.69719309999999},"Seattle":{"lat":47.6062095,"lng":-122.3320708},"Gainesville":{"lat":29.6516344,"lng":-82.32482619999999},"Bloomington":{"lat":39.165325,"lng":-86.52638569999999},"Rosemont":{"lat":41.98675069999999,"lng":-87.8721602},"Ann Arbor":{"lat":42.2808256,"lng":-83.7430378},"Leipzig":{"lat":51.3396955,"lng":12.3730747},"Lexington":{"lat":38.0405837,"lng":-84.5037164},"Ames":{"lat":42.0307812,"lng":-93.63191309999999},"Notre Dame":{"lat":41.7055716,"lng":-86.2353388},"Edmonton":{"lat":53.544389,"lng":-113.4909267},"Rio de Janeiro":{"lat":-22.9068467,"lng":-43.1728965},"Heusden-Zolder":{"lat":51.0384819,"lng":5.2904127},"Somerville":{"lat":42.3875968,"lng":-71.0994968},"Niigata":{"lat":37.9161924,"lng":139.0364126},"10.06.2010":{"lat":39.9717841,"lng":32.7219529},"Knarvik":{"lat":60.54781329999999,"lng":5.291445599999999},"Osaka":{"lat":34.6937378,"lng":135.5021651},"GavÃ¡":{"lat":41.3028274,"lng":2.0019345},"Lagos":{"lat":6.5243793,"lng":3.3792057},"Kitakyushu":{"lat":33.8834093,"lng":130.8752161},"23.06.2012":{"lat":39.9618471,"lng":32.7035331},"Ciudad de MÃ¡laga":{"lat":36.7212737,"lng":-4.4213988},"Fukuoka":{"lat":33.5903547,"lng":130.4017155},"Kanazawa":{"lat":36.56132540000001,"lng":136.6562051},"Shizuoka":{"lat":34.9771201,"lng":138.3830845},"Manchester":{"lat":53.4807593,"lng":-2.2426305},"Okayama":{"lat":34.6551456,"lng":133.9195019},"Yokohama":{"lat":35.4437078,"lng":139.6380256},"Hiroshima":{"lat":34.3852029,"lng":132.4552927},"Carquefou":{"lat":47.29624099999999,"lng":-1.486812},"Nobeoka":{"lat":32.5822723,"lng":131.6650094},"Oita":{"lat":33.2381718,"lng":131.6126189},"Bottrop":{"lat":51.529086,"lng":6.944688699999999},"Cardiff":{"lat":51.48158100000001,"lng":-3.17909},"Marrakesh":{"lat":31.6294723,"lng":-7.981084500000001},"Kumamoto":{"lat":32.8031004,"lng":130.7078911},"Eagle Rock":{"lat":34.13224690000001,"lng":-118.2117257},"Kitami":{"lat":43.8040314,"lng":143.8958758},"Gifu":{"lat":35.4232984,"lng":136.7606537},"Kumagaya":{"lat":36.1473097,"lng":139.3886446},"Hobart":{"lat":41.5322592,"lng":-87.2550353},"Abashiri":{"lat":44.0206319,"lng":144.2733983},"Montreuil":{"lat":48.863812,"lng":2.448451},"HÃ©rouville-Saint-Clair":{"lat":49.20358,"lng":-0.333655},"Sollentuna":{"lat":59.4541218,"lng":17.9242952},"Philadelphia":{"lat":39.9525839,"lng":-75.1652215},"Kofu":{"lat":35.66228,"lng":138.5682015},"Ponzano Veneto":{"lat":45.7175798,"lng":12.2049194},"Marugame":{"lat":34.2895062,"lng":133.7977056},"Barakaldo":{"lat":43.2969875,"lng":-2.9862029},"Kassel":{"lat":51.3127114,"lng":9.4797461},"Merksem":{"lat":51.2512626,"lng":4.4485629},"Tendo":{"lat":38.3622648,"lng":140.3778858},"Den Haag":{"lat":52.0704978,"lng":4.3006999},"Tivoli":{"lat":42.0584242,"lng":-73.9093003},"Corvallis":{"lat":44.5645659,"lng":-123.2620435},"Malbourne":{"lat":-37.8136276,"lng":144.9630576},"Suita":{"lat":34.7594526,"lng":135.51686},"Champaign":{"lat":40.1164204,"lng":-88.2433829},"Cape Town":{"lat":-33.9248685,"lng":18.4240553},"Toronto":{"lat":43.653226,"lng":-79.3831843},"Knoxville":{"lat":35.9606384,"lng":-83.9207392},"Arnhem":{"lat":-28.6423559,"lng":153.613508},"Konosu":{"lat":36.0657584,"lng":139.5221694},"Fukagawa":{"lat":33.8882325,"lng":-118.305339},"Nagoya":{"lat":35.1814464,"lng":136.906398},"Brazzaville":{"lat":-4.2633597,"lng":15.2428853},"Porto-Novo":{"lat":6.4968574,"lng":2.6288523},"Evry-Bondoufle":{"lat":48.6131658,"lng":2.377891},"12.06.2015":{"lat":39.963444,"lng":32.703006},"Waitakere":{"lat":-36.8504238,"lng":174.5425402},"Kuala Lumpur":{"lat":3.139003,"lng":101.686855},"Dedham":{"lat":42.2436085,"lng":-71.1676536},"Bilbao":{"lat":43.2630126,"lng":-2.9349852},"Fukushima":{"lat":37.7608337,"lng":140.4747281},"Namur":{"lat":50.4673883,"lng":4.8719854},"Setagaya":{"lat":35.6465721,"lng":139.6532473},"Hamburg":{"lat":53.5510846,"lng":9.9936819},"Oska":{"lat":50.6225367,"lng":13.691388},"Daegu":{"lat":35.8714354,"lng":128.601445},"Yalta":{"lat":44.49520500000001,"lng":34.166301},"Chemnitz":{"lat":50.827845,"lng":12.9213697},"Mungyeong":{"lat":36.586148,"lng":128.1867972},"Moncton":{"lat":46.0878165,"lng":-64.7782313},"Akita":{"lat":39.7199218,"lng":140.1035697},"Velenje":{"lat":46.3622743,"lng":15.1106582},"Pullman":{"lat":46.7297771,"lng":-117.1817377},"Leiria":{"lat":39.74953310000001,"lng":-8.807682999999999},"North Shore City":{"lat":49.3199816,"lng":-123.0724139},"Kanagawa":{"lat":35.4475073,"lng":139.6423446},"Hiratsuka":{"lat":35.3351103,"lng":139.3494762},"Cheboksary":{"lat":56.11676629999999,"lng":47.262782},"Yamaguchi":{"lat":34.1859563,"lng":131.4706493},"Uden":{"lat":51.6631071,"lng":5.6239227},"Burnaby":{"lat":49.2488091,"lng":-122.9805104},"Pescara":{"lat":42.4617902,"lng":14.2160898},"Kiyakyushu":{"lat":33.8834093,"lng":130.8752161},"Empoli":{"lat":43.7178919,"lng":10.9477782},"Belle vue Mauricia":{"lat":-20.1218931,"lng":57.68074499999999},"Solihull":{"lat":52.411811,"lng":-1.77761},"Orvieto":{"lat":42.7185068,"lng":12.1107446},"Caserta":{"lat":41.0854362,"lng":14.367553},"Fortaleza":{"lat":-3.7319029,"lng":-38.5267393},"Kouvola":{"lat":60.8678835,"lng":26.7041602},"Braitslava":{"lat":48.1485965,"lng":17.1077478},"SaarijÃ¤rvi":{"lat":62.7066981,"lng":25.2553606},"Dresden":{"lat":51.0504088,"lng":13.7372621},"Tajimi":{"lat":35.3328,"lng":137.1320765},"Bari":{"lat":41.1171432,"lng":16.8718715},"Lucca":{"lat":38.5780974,"lng":-121.4844977},"Tuscaloosa":{"lat":33.2098407,"lng":-87.56917349999999},"Haugesund":{"lat":59.41358100000001,"lng":5.267986899999999},"Sapporo":{"lat":43.0620958,"lng":141.3543763},"Kochi":{"lat":9.9312328,"lng":76.26730409999999},"Port Elizabeth":{"lat":-33.7139247,"lng":25.5207358},"Abuja":{"lat":9.0764785,"lng":7.398574},"15.10.2017":{"lat":39.8923025,"lng":32.7162874},"Pisa":{"lat":43.7228386,"lng":10.4016888},"Incheon":{"lat":37.4562557,"lng":126.7052062},"Conegliano":{"lat":45.889197,"lng":12.3006368},"Gavardo":{"lat":45.58482910000001,"lng":10.4418793},"GÃ¤vle":{"lat":60.6748796,"lng":17.1412726},"Izmir":{"lat":38.423734,"lng":27.142826},"PieksÃ¤mÃ¤ki":{"lat":62.29499509999999,"lng":27.13305},"Byrkjelo":{"lat":61.733299,"lng":6.5069117},"Mersin":{"lat":36.8121041,"lng":34.6414811},"Marano":{"lat":45.4640764,"lng":12.1180936},"Ludwigshafen":{"lat":49.47741,"lng":8.445179999999999},"30.06.2011":{"lat":39.9714951,"lng":32.720489},"Tartu":{"lat":58.3776252,"lng":26.7290062},"Baku":{"lat":40.40926169999999,"lng":49.8670924},"LÃ¼denscheid":{"lat":51.2191038,"lng":7.631259999999999},"Des Moines":{"lat":41.6005448,"lng":-93.6091064},"29.06.1996":{"lat":39.9719624,"lng":32.7272457},"Bellville":{"lat":29.9502253,"lng":-96.2571858},"NykÃ¶ping":{"lat":58.75284389999999,"lng":17.0091593},"Colombes":{"lat":48.9220615,"lng":2.2533313},"Croix-de-Bernay":{"lat":49.0915323,"lng":0.5979099999999999},"Tunis":{"lat":36.8064948,"lng":10.1815316},"Tottori":{"lat":35.5011326,"lng":134.2350914},"Palafrugell":{"lat":41.9179145,"lng":3.1628837},"Watford":{"lat":51.656489,"lng":-0.39032},"Vigo":{"lat":42.24059889999999,"lng":-8.7207268},"Viry-ChÃ¢tillon":{"lat":48.666218,"lng":2.375902},"Kushiro":{"lat":42.9848542,"lng":144.3813556},"Jarrow":{"lat":54.980297,"lng":-1.482757},"Houston":{"lat":29.7604267,"lng":-95.3698028},"Buenos Aires":{"lat":-34.6036844,"lng":-58.3815591},"Toyota":{"lat":37.2231295,"lng":-95.7327976},"Chestnut Hill":{"lat":40.0703334,"lng":-75.2070644},"27.06.2012":{"lat":39.9628461,"lng":32.7033979},"Saint-Ã‰tienne":{"lat":45.439695,"lng":4.3871779},"Coimbra":{"lat":40.2033145,"lng":-8.4102573},"AlmerÃ­a":{"lat":36.834047,"lng":-2.4637136},"Heidelberg":{"lat":38.94683089999999,"lng":-92.32746999999999},"Heinola":{"lat":61.2102113,"lng":26.0457548},"BanskÃ¡ Bystrica":{"lat":48.736277,"lng":19.1461917},"Grande-Synthe":{"lat":51.013547,"lng":2.302577},"Busan":{"lat":35.1795543,"lng":129.0756416},"Herzogenaurach":{"lat":49.5682987,"lng":10.8828577},"Guangzhou":{"lat":23.12911,"lng":113.264385},"Nanjing":{"lat":32.060255,"lng":118.796877},"Brunswick":{"lat":31.1499528,"lng":-81.49148939999999},"Craiova":{"lat":44.3301785,"lng":23.7948807},"Wuhan":{"lat":30.592849,"lng":114.305539},"Fana":{"lat":60.2630972,"lng":5.345251999999999},"Isahaya":{"lat":32.8434379,"lng":130.0530952},"Waltham":{"lat":42.3764852,"lng":-71.2356113},"Jinzhou":{"lat":41.095685,"lng":121.1268459},"Kobe":{"lat":34.690083,"lng":135.1955112},"Nakuru":{"lat":-0.3030988,"lng":36.080026},"Nagasaki":{"lat":32.7502856,"lng":129.877667},"Utrecht":{"lat":52.09073739999999,"lng":5.1214201},"Kagoshima":{"lat":31.5965535,"lng":130.5571158},"Pune":{"lat":18.5204303,"lng":73.8567437},"Derby":{"lat":41.3206523,"lng":-73.0889973},"Dubai":{"lat":25.2048493,"lng":55.2707828},"Kasarani":{"lat":-1.2278411,"lng":36.9057288},"Addis Ababa":{"lat":8.9806034,"lng":38.7577605},"Catania":{"lat":37.5078772,"lng":15.0830304},"Takamatsu":{"lat":34.3427879,"lng":134.046574},"Braga":{"lat":41.5454486,"lng":-8.426506999999999},"Saransk":{"lat":54.2000477,"lng":45.1745115},"01.07.1989":{"lat":34.6068716,"lng":-82.4891837},"Tianjin":{"lat":39.3433574,"lng":117.3616476},"Papakura":{"lat":-37.0677049,"lng":174.9436176},"Lohja":{"lat":60.251176,"lng":24.0674709},"Maia":{"lat":41.2278891,"lng":-8.621049},"Gorkiy":{"lat":45.980833,"lng":40.789444},"LillestrÃ¸m":{"lat":59.9559696,"lng":11.0503785},"Almaty":{"lat":43.2220146,"lng":76.8512485},"Kyoto":{"lat":35.0116363,"lng":135.7680294},"Amsterdam":{"lat":52.3702157,"lng":4.895167900000001},"Bergish Gladbach":{"lat":50.9923091,"lng":7.1286213},"Toyonaka":{"lat":34.7812658,"lng":135.4697387},"Tampa":{"lat":27.950575,"lng":-82.4571776},"Hamamatsu":{"lat":34.7108344,"lng":137.7261258},"26.06.2004":{"lat":39.9628461,"lng":32.7033979},"Plovdiv":{"lat":42.1354079,"lng":24.7452904},"Rifu":{"lat":38.3301895,"lng":140.9757222},"Braunschweig":{"lat":52.2688736,"lng":10.5267696},"Szizuoka":{"lat":34.9771201,"lng":138.3830845},"Norwalk":{"lat":33.9022367,"lng":-118.081733},"Kawasaki":{"lat":37.8164223,"lng":-96.88384049999999},"Himeji":{"lat":34.815149,"lng":134.6853528},"Shijiazhuang":{"lat":38.042805,"lng":114.514893},"Yerino":{"lat":55.4511152,"lng":37.514492},"Columbia":{"lat":34.0007104,"lng":-81.0348144},"Torrance":{"lat":33.8358492,"lng":-118.3406288},"Baunatal":{"lat":51.2537283,"lng":9.414599899999999},"Gaborone":{"lat":-24.6282079,"lng":25.9231471},"Kropyvnytskiy":{"lat":48.50793300000001,"lng":32.262317},"Hachioji":{"lat":35.6663394,"lng":139.3158056},"Tel Aviv":{"lat":32.0852999,"lng":34.78176759999999},"Naruto":{"lat":34.1725623,"lng":134.6087858},"Perth":{"lat":-31.9505269,"lng":115.8604572},"Birmingham AL":{"lat":33.5206608,"lng":-86.80248999999999},"Grodno":{"lat":53.6693538,"lng":23.8131306}}
// FOR STORING ALL NEW LOCATIONS
var locationCacheNew = {"myHouse":{"lat":40.7127753,"lng":-74.0059728}}
function engageGeolocate(locationIn,_eventString){
	var title = _eventString;
	if (only50 < 1000){
		if(locationCache.hasOwnProperty(locationIn)){
			var marker = L.marker(new L.LatLng(locationCache[locationIn].lat, locationCache[locationIn].lng), { title: title });
			marker.bindPopup(title);
			markers.addLayer(marker); 
		}else{
			only50 = only50 + 1
			if (only50 == 1){
				console.log("ADD NEW LOCATIONS TO THE CACHE!!!!. Use this syntax in the browser:")
				console.log("JSON.stringify(locationCacheNew)")
				console.log(locationIn)
			}
			var theLocationUrl = "https://maps.googleapis.com/maps/api/geocode/json?address=" + locationIn + "&key=AIzaSyBa5ArWpxDbS8Mlw77x3d5GzL9-SIO3YNA"
			$.get(theLocationUrl, function(response) { 
				/*console.log(locationIn)
				console.log(response)
				console.log(response.results["0"].formatted_address)
				console.log(response.results["0"].geometry.location)
				console.log("_____________________________")*/
				//L.marker([response.results["0"].geometry.location.lat, response.results["0"].geometry.location.lng]).addTo(mymap);
				if (response.results["0"]){
					var marker = L.marker(new L.LatLng(response.results["0"].geometry.location.lat, response.results["0"].geometry.location.lng), { title: title });
					marker.bindPopup(title);
					markers.addLayer(marker);

					locationCache[locationIn] = {"lat": response.results["0"].geometry.location.lat, "lng": response.results["0"].geometry.location.lng}
					locationCacheNew[locationIn] = {"lat": response.results["0"].geometry.location.lat, "lng": response.results["0"].geometry.location.lng}
				}else{ 
					"...failed to geocode: " + locationIn
				}
				
				/* for plotting elevation of events in the future (doesnt work currently)
				var theLatLngUrl = "https://maps.googleapis.com/maps/api/elevation/json?locations=" + response.results["0"].geometry.location.lat + "," + response.results["0"].geometry.location.lng + "&key=AIzaSyBgzxw2Xk2ymD-fovOmyILjrfOJqkaBdLo"
				$.get(theLatLngUrl, function(responseHeight) {
					console.log(responseHeight)
				}); 
				*/
			});
		}
	}
}

function parseBigString(stringIn){
	var lineArray = stringIn.replace(/\<font color="#3399CC">/g,'').replace(/\<\/font>/g,'').replace(/\&#13;/g,'').split("\n")//.split("	");
	console.log(100 / lineArray.length)
	lines = 0;
	//widthBar = 0.3;
	deviceWidth = ((window.innerWidth > 0) ? window.innerWidth : screen.width) * 0.95;
	widthBar = (deviceWidth / lineArray.length)
	arrayArray = []
	highestDate = 0;
	lowestDate = 999999999999999999999999;
	highestTtl = 0;
	lowestTtl = 999999999999999999999999;
	highestAge = 0;
	lowestAge = 999999999999999999999999;
	for (g = 0; g < lineArray.length; g++) {
		var lineParsed = lineArray[g].split("   ")
		var paredArray = []
		for (f = 0; f < lineParsed.length; f++) {
			lineParsed[f] = $.trim(lineParsed[f]);
			if(lineParsed[f] != ""){
				paredArray.push(lineParsed[f])
			}
		}
		if (typeof paredArray[1] !== 'undefined') {
			if (g != 0){
				makeHistogram(paredArray)
			}
		}
	}
}
function checkCentury(yearIn){
 if (parseFloat(yearIn) <= 17){
	 return "20" + yearIn
 }else{
	 return "19" + yearIn
 }
}
function makeHistogram(recordArrayIn){
	//console.log(recordArrayIn)
	lines++
	var raw = recordArrayIn[1]
	//console.log(raw)
	var min = raw.split(":")[0].replace(/[^\d\.]/g, '')
	var sec_hds = (raw.split(":")[1]).split(".")
	var sec = sec_hds[0].replace(/[^\d\.]/g, '')
	if (cutOffValue < 200000){
		var hds = sec_hds[1].replace(/[^\d\.]/g, '')
		var hdh = 0
	}else{
		var hds = 0
		var hdh = (raw.split(":")[0]).replace(/[^\d\.]/g, '')
	}
	var true_hds = (hds).toString()
	if(true_hds.length == 1){
		true_hds = true_hds + "0"
	}
	var ttl = ((min * 60) * 100) + (sec * 100) + parseFloat(true_hds)
	if (ttl < cutOffValue){
		recordArrayIn.push(ttl);
		var a2 = "S."+(recordArrayIn[4])+".F" // Had to hack in some strings because the function was interpreting this value as a computer number of sort
		var r2 = "S."+(recordArrayIn[7])+".F" // ditto
		var day_mth_yr_DOB = (a2.split("."))
		var day_mth_yr = (r2.split("."))
		var trueTimeValue = parseFloat(day_mth_yr[1]) + parseFloat(day_mth_yr[2] * 30) + parseFloat(day_mth_yr[3] * (12*30))
		var trueAgeValue_DOB = parseFloat(day_mth_yr_DOB[1]) + parseFloat(day_mth_yr_DOB[2] * 30) + parseFloat(parseFloat(checkCentury(day_mth_yr_DOB[3])) * (12*30))
		var trueAgeValue = trueTimeValue - trueAgeValue_DOB
		var trueAgeValueArray = (("S."+(trueAgeValue / (12*30))+".F").toString()).split(".")//.toFixed(3)
		var trueAgeValue2 = trueAgeValueArray[1] +" Years " +  (((parseFloat("."+trueAgeValueArray[2])) * 365).toFixed(0)).toString() + " Days"
		recordArrayIn.push(trueTimeValue)
		if (ttl > highestTtl){
			highestTtl = ttl; 
		}
		if (ttl < lowestTtl){
			lowestTtl = ttl; 
		}
		if (trueAgeValue > highestAge){
			highestAge = trueAgeValue; 
		}
		if (trueAgeValue < lowestAge){
			lowestAge = trueAgeValue; 
		}
		if (trueTimeValue > highestDate){
			highestDate = trueTimeValue; 
		}
		if (trueTimeValue < lowestDate){
			lowestDate = trueTimeValue; 
		}
		recordArrayIn.push(trueAgeValue)
		recordArrayIn.push(trueAgeValue2)
		arrayArray.push(recordArrayIn)
	}else{
		console.log(ttl)
	}
}

function makeMoreStuff(){
	console.log(highestTtl)
	$("#histogram-labels").show(); // Show labels when data loads
	var differenceDate = highestDate - lowestDate;
	var differenceAge = highestAge - lowestAge;
	var lines = 0;
	var nextAge = 0;
	var totalWidth = arrayArray.length * widthBar; // Total width of histogram
	
	for (f = 0; f < arrayArray.length; f++) {
		lines++;
		var recordArrayIn = arrayArray[f];
		var x = parseFloat(recordArrayIn[9]);
		var y = lowestDate;
		var z = differenceDate;
		var diffVarDate = (x - y)/z
		var xAge = parseFloat(recordArrayIn[10]);
		var yAge = lowestAge;
		var zAge = differenceAge;
		var diffVarAge = (xAge - yAge)/zAge
		var ttl = parseFloat(recordArrayIn[8])
		var heightPct = (ttl - lowestTtl)/(highestTtl - lowestTtl)
		var heightMax = 200
		var heightVal = heightMax * heightPct
		var a = arrayArray.length;
		var b = (widthBar - 0)//0.0000001)
		var functionString = 'onmouseover="mouseoverKeyA(this)" onmouseout="mouseoutKeyA(this)"'
		var leftVarDate = ((a * b) * diffVarDate)
		var leftVarAge = ((a * b) * diffVarAge)
		var statsString = 'recordId="'+ '_'+recordArrayIn[0] + '"' + 'time="'+ recordArrayIn[1] + '"' + 'athlete="'+ recordArrayIn[2] + '"' + 'eventDate="'+ recordArrayIn[7] + '"' + 'athleteAgeDOB="'+ recordArrayIn[11] + '"' + 'athleteAge="'+ recordArrayIn[4] + '"' + 'eventLocation="'+ recordArrayIn[6] + '"'
		engageGeolocate(recordArrayIn[6],statsString)
		var htmlString = '<div ' + functionString + 'id="'+ 'raw_'+recordArrayIn[0] + '"' + statsString + ' style="width:'+ widthBar +'px; position: absolute; top:' + (heightMax - heightVal) +'px; left:'+ (lines * (widthBar - 0.0000001)) +'px; height:'+ heightVal +'px; background-color:gray;"></div>'
		$( "#new-projects" ).append( htmlString );
		var htmlString2 = '<div ' + functionString + 'id="'+ 'hist_'+recordArrayIn[0] + '"' + statsString + ' style="width:'+ widthBar +'px; position: absolute; top:' + ((heightMax - heightVal) + 225) +'px; left:'+ leftVarDate +'px; height:'+ heightVal +'px; background-color:gray;"></div>'
		$( "#new-projects" ).append( htmlString2 );
		var htmlString3 = '<div ' + functionString + 'id="'+ 'age_'+recordArrayIn[0] + '"' + statsString + ' style="width:'+ widthBar +'px; position: absolute; top:' + ((heightMax - heightVal) + 500) +'px; left:'+ leftVarAge +'px; height:'+ heightVal +'px; background-color:gray;"></div>'
		$( "#new-projects" ).append( htmlString3 );
		if (xAge > nextAge){
			var htmlString2a = '<div id="'+ 'hist_'+recordArrayIn[0] + '" style="width:'+ 3 +'px; position: absolute; top:700px; left:'+ leftVarAge +'px; height: 10px; background-color:gray;"></div>'
			$( "#new-projects" ).append( htmlString2a );
			nextAge = Math.ceil(xAge)
		}
		if (f === arrayArray.length -1){
			var oneNormalizedYear = 365
			var totalYears = (differenceDate / oneNormalizedYear)
			//console.log(totalYears)
			var x2 = 365;
			var y2 = lowestDate;
			var z2 = differenceDate;
			var diffLabelVarDate = (x2 - y2)/z2
			var labelVarDate = ((a * b) * diffLabelVarDate)
			var htmlLabel = '<div style="position: absolute; top:' + (235) +'px; left:'+ labelVarDate +'px;">'+"TEST"+'</div>'
			$( "#new-projects" ).append( htmlLabel );
		}
	}
	//var selectHeightMax = 200
	//var selectLeftVar = ((a * b) * diffVarDate)
	//var selectHtmlString2 = '<div style="width:'+ 2 +'px; position: absolute; top:' + (250) +'px; left:'+ 0 +'px; height:'+ selectHeightMax  +'px; background-color:blue;"></div>'
	//$( "#new-projects" ).append( selectHtmlString2 );	
	/*var $someElement = $("#info-anno"); 
	$(document).mousemove(function(e) { 
		$someElement.offset({ top: (e.pageY - 100), left: (e.pageX + 25)});
	})*/
	mymap.addLayer(markers);
	
	// Generate X-axis labels
	generateAxisLabels(totalWidth, differenceDate, differenceAge);
	
	loadingBar("OFF")
}

// Generate x-axis labels for all three histograms
function generateAxisLabels(totalWidth, differenceDate, differenceAge) {
	var labelStyle = 'position: absolute; font-size: 10px; color: #666; transform: rotate(-45deg); transform-origin: top left;';
	
	// --- RANK LABELS (Histogram 1) ---
	var totalRecords = arrayArray.length;
	var rankStep = Math.ceil(totalRecords / 10); // ~10 labels
	for (var i = 0; i <= totalRecords; i += rankStep) {
		var rank = i === 0 ? 1 : i;
		var leftPos = (rank / totalRecords) * totalWidth;
		var label = '<div class="axis-label" style="' + labelStyle + ' top: 205px; left: ' + leftPos + 'px;">#' + rank + '</div>';
		$("#new-projects").append(label);
	}
	
	// --- DATE LABELS (Histogram 2) ---
	// Convert lowestDate/highestDate back to years
	var lowestYear = Math.floor(lowestDate / (12 * 30));
	var highestYear = Math.ceil(highestDate / (12 * 30));
	var yearStep = Math.ceil((highestYear - lowestYear) / 10); // ~10 labels
	if (yearStep < 1) yearStep = 1;
	
	for (var year = lowestYear; year <= highestYear; year += yearStep) {
		var yearValue = year * (12 * 30);
		var pct = (yearValue - lowestDate) / differenceDate;
		if (pct >= 0 && pct <= 1) {
			var leftPos = pct * totalWidth;
			var label = '<div class="axis-label" style="' + labelStyle + ' top: 430px; left: ' + leftPos + 'px;">' + year + '</div>';
			$("#new-projects").append(label);
		}
	}
	
	// --- AGE LABELS (Histogram 3) ---
	var lowestAgeYears = Math.floor(lowestAge / (12 * 30));
	var highestAgeYears = Math.ceil(highestAge / (12 * 30));
	var ageStep = Math.ceil((highestAgeYears - lowestAgeYears) / 10);
	if (ageStep < 1) ageStep = 1;
	
	for (var age = lowestAgeYears; age <= highestAgeYears; age += ageStep) {
		var ageValue = age * (12 * 30);
		var pct = (ageValue - lowestAge) / differenceAge;
		if (pct >= 0 && pct <= 1) {
			var leftPos = pct * totalWidth;
			var label = '<div class="axis-label" style="' + labelStyle + ' top: 705px; left: ' + leftPos + 'px;">' + age + 'y</div>';
			$("#new-projects").append(label);
		}
	}
}
function mouseoverKeyA(eDiv){
	var eDivD3 = d3.select(eDiv) 
	var athlete = eDivD3.attr("athlete")
	var time = eDivD3.attr("time")
	var eDate = eDivD3.attr("eventDate")
	var eLocation = eDivD3.attr("eventLocation")
	var aAge = eDivD3.attr("athleteAge")
	var aAgeDOB = eDivD3.attr("athleteAgeDOB")
	console.log(eDivD3.attr("recordId"))
	$("#raw" + eDivD3.attr("recordId")).css("background-color","yellow").css("width","2px").css("z-index","99999999");
	$("#hist" + eDivD3.attr("recordId")).css("background-color","yellow").css("width","2px").css("z-index","99999999");
	$("#age" + eDivD3.attr("recordId")).css("background-color","yellow").css("width","2px").css("z-index","99999999");
	var infoAnno = $( "#info-anno" );
	infoAnno.html("Athlete: <b>" + athlete +"</b><br>Time: <b>" + time +"</b><br>Date: <b>" + eDate +"</b><br>Location: <b>" + eLocation +"</b><br>Athlete DOB: <b>" + aAge +"</b><br>Athlete Age: <b>" + aAgeDOB + "</b>");
}

function mouseoutKeyA(eDiv){
	var eDivD3 = d3.select(eDiv) 
	$("#raw" + eDivD3.attr("recordId")).css("background-color","gray").css("width",widthBar+"px").css("z-index","100");
	$("#hist" + eDivD3.attr("recordId")).css("background-color","gray").css("width",widthBar+"px").css("z-index","100");
	$("#age" + eDivD3.attr("recordId")).css("background-color","gray").css("width",widthBar+"px").css("z-index","100");
	$( "#info-anno" ).html("")
}

</script>
</body>
</html>